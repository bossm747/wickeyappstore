<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Custom WAS Test Page</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="src/favicon.ico">

  <!-- WickeyAppStore CSS -->
  <link rel="stylesheet" href="elements/styles.css">
</head>

<body>
  <wickey-appstore></wickey-appstore>
  <script type="text/javascript" src="elements/wickeyappstore.js"></script>

  <script>
    const wickeyappstore = document.querySelector('wickey-appstore');
    wickeyappstore.addEventListener('open', (event) => {
      console.log('WAS button opened');  // can pause game here.
    });
    const userService = window.WAS.userService;
    const dataService = window.WAS.dataService;
    userService.user.subscribe(usr => {
      console.log('userServiceOut user.subscribe', usr);
    });
    // Check if purchased (where 10 is your purchase item id).
    userService.checkIfPurchased(10).subscribe(isPurch => {
      console.log('checkIfPurchased', isPurch);
    });
    // Example of how to pass in own save conflict mapping function.
    // Default mapping will choose the newest save.
    function onSaveConflict(localSave, cloudSave) {
      let keepSave = localSave;
      if (localSave && cloudSave) {
        if (cloudSave.highScore > localSave.highScore) {
          keepSave = cloudSave;
        }
      }
      return keepSave;
    }
    dataService.restore(onSaveConflict).subscribe(mydata => {
      console.log('wasDataService.restore', mydata);
      // WasDataService is now loaded and restored (ready for use).
      // dataService.get('highScore');
      // dataService.save('highScore', 3000);
      // Then after the session (or game level), persist to cloud
      // dataService.persist();

      // Get leaderboard: Can pass in username to get rank.
      userService.getLeaderboard(userService.userObject.username).subscribe(res => {
        console.log('leaderboard', res.leaderboard);  // [{score: number, username: string}, ...] The top entries will be returned.
        console.log('rank', res.rank);  // If a username was passed in, this is the rank:number of that username (0 is first).
      });
    });
    // Example of adding to Leaderboard
    function addToLeaderboard(_alreadyTaken) {
      let _showMsg = null;
      if (_alreadyTaken === true) {
        _showMsg = 'Username already taken! Enter username for leaderboard';
      } else {
        _showMsg = 'Enter username for leaderboard';
      }
      // Ask for username for leaderboard
      let _username;
      // NOTE: prompt is used here for simplicity, any input may be used to get the username.
      if (userService.userObject.username === userService.userObject.user_id) {
        _username = prompt(_showMsg);
      } else {
        _username = prompt(_showMsg, userService.userObject.username);
      }
      if (_username !== null && _username !== '') {
        userService.updateUsername(_username).subscribe(usr => {
          // Updated username
          userService.setHighscore(this.highScore);
        }, (error) => {
          if (error === 'Username already taken') {
            this.addToLeaderboard(true);
          }
        });
      }
    }
  </script>
</body>

</html>
